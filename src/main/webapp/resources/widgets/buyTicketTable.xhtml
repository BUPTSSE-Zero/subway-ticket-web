<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns:cc="http://xmlns.jcp.org/jsf/composite"
      xmlns:c="http://java.sun.com/jsp/jstl/core"
      xmlns:p="http://primefaces.org/ui">

    <cc:interface>
        <cc:attribute name="startStation" required="true" type="com.subwayticket.database.model.SubwayStation"/>
        <cc:attribute name="endStation" required="true" type="com.subwayticket.database.model.SubwayStation"/>
        <cc:attribute name="ticketPrice" required="true" type="com.subwayticket.database.model.TicketPrice"/>
        <cc:attribute name="preferButtonUpdate"/>
    </cc:interface>

    <cc:implementation>
        <table>
            <thead>
            <tr>
                <th data-field="start_station">#{bundle.StartSubwayStation}</th>
                <th data-field="end_station">#{bundle.EndSubwayStation}</th>
                <th data-field="ticket_price">#{bundle.TicketPrice}</th>
                <th data-field="ticket_amount">#{bundle.TicketNumber}</th>
                <th data-field="ticket_total_price">#{bundle.TotalPrice}</th>
            </tr>
            </thead>

            <tbody>
            <tr>
                <td>
                    <h:form>
                        <span class="#{cc.attrs.id}-start-station" data-disable="#{not cc.attrs.startStation.available}"
                              station-msg="#{cc.attrs.startStation.stationMessage.content}"
                              station-msg-time="#{cc.attrs.startStation.stationMessage.releaseTime.time}"
                              station-msg-publisher="#{cc.attrs.startStation.stationMessage.publisher}">
                            #{cc.attrs.startStation.displayName}
                        </span>
                        <script type="text/javascript">
                            initStationMessage('.#{cc.attrs.id}-start-station');
                        </script>
                        <c:choose>
                            <c:when test="#{not empty sessionScope.user and preferBean.isStationPrefer(cc.attrs.startStation)}">
                                <p:commandButton styleClass="btn-floating btn-flat transparent waves-effect prefer-button"
                                                 icon="ui-icon-star" actionListener="#{preferBean.removePreferSubwayStation(cc.attrs.startStation)}"
                                                 update="#{cc.attrs.preferButtonUpdate}"
                                                 onsuccess="Materialize.toast('#{bundle.TipRemovePreferStationSuccess}', 4000, 'rounded')">
                                    <f:actionListener binding="#{subwayInfoBean.refreshUser()}"/>
                                </p:commandButton>
                            </c:when>
                            <c:when test="#{not empty sessionScope.user}">
                                <p:commandButton styleClass="btn-floating btn-flat transparent waves-effect prefer-button"
                                                 icon="ui-icon-star-border" actionListener="#{preferBean.addPreferSubwayStation(cc.attrs.startStation)}"
                                                 onsuccess="Materialize.toast('#{bundle.TipAddPreferStationSuccess}', 4000, 'rounded')"
                                                 update="#{cc.attrs.preferButtonUpdate}">
                                    <f:actionListener binding="#{subwayInfoBean.refreshUser()}"/>
                                </p:commandButton>
                            </c:when>
                        </c:choose>
                    </h:form>
                </td>
                <td>
                    <h:form>
                        <span class="#{cc.attrs.id}-end-station" data-disable="#{not cc.attrs.endStation.available}"
                              station-msg="#{cc.attrs.endStation.stationMessage.content}"
                              station-msg-time="#{cc.attrs.endStation.stationMessage.releaseTime.time}"
                              station-msg-publisher="#{cc.attrs.endStation.stationMessage.publisher}">
                            #{cc.attrs.endStation.displayName}
                        </span>
                        <script type="text/javascript">
                            initStationMessage('.#{cc.attrs.id}-end-station');
                        </script>
                        <c:choose>
                            <c:when test="#{not empty sessionScope.user and preferBean.isStationPrefer(cc.attrs.endStation)}">
                                <p:commandButton styleClass="btn-floating btn-flat transparent waves-effect prefer-button"
                                                 icon="ui-icon-star" actionListener="#{preferBean.removePreferSubwayStation(cc.attrs.endStation)}"
                                                 update="#{cc.attrs.preferButtonUpdate}"
                                                 onsuccess="Materialize.toast('#{bundle.TipRemovePreferStationSuccess}', 4000, 'rounded')">
                                    <f:actionListener binding="#{subwayInfoBean.refreshUser()}"/>
                                </p:commandButton>
                            </c:when>
                            <c:when test="#{not empty sessionScope.user}">
                                <p:commandButton styleClass="btn-floating btn-flat transparent waves-effect prefer-button"
                                                 icon="ui-icon-star-border" actionListener="#{preferBean.addPreferSubwayStation(cc.attrs.endStation)}"
                                                 onsuccess="Materialize.toast('#{bundle.TipAddPreferStationSuccess}', 4000, 'rounded')"
                                                 update="#{cc.attrs.preferButtonUpdate}">
                                    <f:actionListener binding="#{subwayInfoBean.refreshUser()}"/>
                                </p:commandButton>
                            </c:when>
                        </c:choose>
                    </h:form>
                </td>
                <td>
                    <h:outputText value="#{cc.attrs.ticketPrice.price}">
                        <f:convertNumber currencySymbol="￥" type="currency" minFractionDigits="2" maxFractionDigits="2"/>
                    </h:outputText>
                </td>
                <td>
                    <p:importConstants type="com.subwayticket.control.TicketOrderControl" var="orderControl"/>
                    <script type="text/javascript">
                        function onTicketAmountChange(ticketprice, delta){
                            var ticketAmount = parseInt($('##{cc.attrs.id}-ticketamount').text()) + delta;
                            if(ticketAmount &lt;= 0)
                                ticketAmount = 1;
                            else if(ticketAmount > #{orderControl.MAX_TICKET_AMOUNT})
                                ticketAmount = #{orderControl.MAX_TICKET_AMOUNT};
                            $('##{cc.attrs.id}-ticketamount').text(ticketAmount);
                            $('##{cc.attrs.id}-totalprice').text((ticketprice * ticketAmount).toFixed(2));
                            $('##{cc.attrs.id}-ticketamount-hinput').val(ticketAmount);
                        }
                    </script>
                    <span id="#{cc.attrs.id}-ticketamount">1</span>
                    <a class="btn-floating btn-flat transparent waves-effect" onclick="onTicketAmountChange(#{cc.attrs.ticketPrice.price}, -1)">
                        <i class="material-icons red-text">remove</i>
                    </a>
                    <a class="btn-floating btn-flat transparent waves-effect" onclick="onTicketAmountChange(#{cc.attrs.ticketPrice.price}, 1)">
                        <i class="material-icons light-green-text">add</i>
                    </a>
                </td>
                <td>
                    <span class="red-text" style="font-size: 25px; font-weight: bold">￥</span>
                    <span id="#{cc.attrs.id}-totalprice" class="red-text" style="font-size: 25px; font-weight: bold">
                        <h:outputText value="#{cc.attrs.ticketPrice.price}">
                            <f:convertNumber minFractionDigits="2" maxFractionDigits="2"/>
                        </h:outputText>
                    </span>
                </td>
            </tr>
            <c:choose>
                <c:when test="#{empty sessionScope.user}">
                    <tr>
                        <td colspan="5" style="padding: 0;">
                            <p class="right red-text">
                                #{bundle.TipBuyTicketAfterLogin}
                            </p>
                        </td>
                    </tr>
                </c:when>
                <c:otherwise>
                    <tr>
                        <td colspan="5" style="padding: 0">
                            <h:form>
                                <c:choose>
                                    <c:when test="#{preferBean.isRoutePrefer(cc.attrs.startStation, cc.attrs.endStation)}">
                                        <p:commandButton styleClass="btn red waves-effect waves-light left"
                                                         icon="ui-icon-remove" value="#{bundle.RemovePreferRoute}"
                                                         actionListener="#{preferBean.removePreferSubwayRoute(cc.attrs.startStation, cc.attrs.endStation)}"
                                                         onsuccess="Materialize.toast('#{bundle.TipRemovePreferRoute}', 4000, 'rounded')"
                                                         update="#{cc.attrs.preferButtonUpdate}">
                                            <f:actionListener binding="#{preferBean.refreshUser()}"/>
                                        </p:commandButton>
                                    </c:when>
                                    <c:otherwise>
                                        <p:commandButton styleClass="btn deep-purple waves-effect waves-light left"
                                                         icon="ui-icon-add" value="#{bundle.AddToPreferRoute}"
                                                         actionListener="#{preferBean.addPreferSubwayRoute(cc.attrs.startStation, cc.attrs.endStation)}"
                                                         onsuccess="Materialize.toast('#{bundle.TipAddPreferRouteSuccess}', 4000, 'rounded')"
                                                         update="#{cc.attrs.preferButtonUpdate}">
                                            <f:actionListener binding="#{preferBean.refreshUser()}"/>
                                        </p:commandButton>
                                    </c:otherwise>
                                </c:choose>
                            </h:form>
                            <h:form>
                                <input type="hidden" id="#{cc.attrs.id}-ticketamount-hinput" name="ticketAmount" value="1"/>
                                <p:commandButton styleClass="btn green darken-1 waves-effect waves-light right" icon="ui-icon-done" type="submit"
                                                 actionListener="#{orderBean.submitOrder(cc.attrs.startStation, cc.attrs.endStation, cc.attrs.ticketPrice)}"
                                                 value="#{bundle.SubmitOrder}"/>
                            </h:form>
                        </td>
                    </tr>
                </c:otherwise>
            </c:choose>
            </tbody>
        </table>
    </cc:implementation>

</html>
