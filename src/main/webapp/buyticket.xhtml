<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                xmlns:h="http://xmlns.jcp.org/jsf/html"
                xmlns:f="http://xmlns.jcp.org/jsf/core"
                xmlns:p="http://primefaces.org/ui"
                xmlns:c="http://java.sun.com/jsp/jstl/core"
                xmlns:w="http://java.sun.com/jsf/composite/widgets"
                template="/templates/main-template.xhtml">

    <ui:define name="login-button">
        <p:commandButton styleClass="submit-button btn waves-effect waves-light amber" type="submit"
                         value="#{bundle.Login}" actionListener="#{userOperationBean.login}" icon="ui-icon-enter"
                         update="login_error_message header-panel normal-buyticket-panel" oncomplete="handleLoginResult(xhr, status, args)">
            <f:actionListener binding="#{buyTicketBean.updateUser()}"/>
        </p:commandButton>
    </ui:define>

    <ui:define name="logout-button">
        <p:commandButton styleClass="btn transparent z-depth-0 black-text" actionListener="#{userOperationBean.logout}" value="#{bundle.Logout}"
                         style="float: left; height: 50px; line-height: 50px; text-align: left; padding: 0"
                         update="header-panel normal-buyticket-panel">
            <f:actionListener binding="#{buyTicketBean.updateUser()}"/>
        </p:commandButton>
    </ui:define>

    <ui:define name="page-panel-content">
        <h:outputScript library="js" name="station-msg.js"/>
        <script type="text/javascript">
            $(document).ready(function() {
                $('select').material_select();
            });
        </script>
        <div style="padding: 15px">
            <div class="row" style="margin-bottom: 0">
                <h:form class="col s12">
                    <div class="row" style="margin-bottom: 0">
                        <div class="col" style="padding-top: 20px">
                            <i class="material-icons">location_city</i>
                        </div>
                        <div class="input-field col s1">
                            <h:selectOneMenu>
                                <c:forEach items="#{buyTicketBean.cities}" var="city">
                                    <f:selectItem itemLabel="#{city.cityName}"/>
                                </c:forEach>
                            </h:selectOneMenu>
                            <label>#{bundle.City}</label>
                        </div>
                        <div class="col" style="padding-top: 20px">
                            <i class="material-icons">subway</i>
                        </div>
                        <div class="input-field col s3" style="margin-right: 40px">
                            <w:stationAutoComplete value="#{buyTicketBean.startStationId}" id="start-station-autocomplete" stationNameClass="start-station-text"
                                                   enableStationMessage="#{true}" completeMethod="#{buyTicketBean.searchStation}"
                                                   required="true" requiredMessage="#{bundle.TipSelectStartStation}"
                                                   label="#{bundle.StartSubwayStation}"/>
                        </div>
                        <div class="col" style="padding-top: 20px">
                            <i class="material-icons">trending_flat</i>
                        </div>
                        <div class="input-field col s3" style="margin-right: 40px">
                            <w:stationAutoComplete id="end-station-autocomplete" value="#{buyTicketBean.endStationId}" stationNameClass="end-station-text"
                                                   enableStationMessage="#{true}" completeMethod="#{buyTicketBean.searchStation}"
                                                   required="true" requiredMessage="#{bundle.TipSelectEndStation}"
                                                   label="#{bundle.EndSubwayStation}"/>
                        </div>
                        <div class="input-field col">
                            <p:commandButton styleClass="btn light-green waves-effect waves-light" icon="ui-icon-search" value="#{bundle.Search}"
                                             update="select-station-msg normal-buyticket-panel"
                                             actionListener="#{buyTicketBean.searchTicketPrice}"/>
                        </div>
                    </div>
                    <p:messages id="select-station-msg" closable="true" autoUpdate="false"/>
                </h:form>
            </div>

            <p:outputPanel id="normal-buyticket-panel">
                <c:if test="#{not empty buyTicketBean.ticketPrice}">
                    <table style="width: 60%; margin: auto">
                        <thead>
                        <tr>
                            <th data-field="start_station">#{bundle.StartSubwayStation}</th>
                            <th data-field="end_station">#{bundle.EndSubwayStation}</th>
                            <th data-field="ticket_price">#{bundle.TicketPrice}</th>
                        </tr>
                        </thead>

                        <tbody>
                        <tr>
                            <td>
                                <h:form>
                                    #{buyTicketBean.startStation.displayName}
                                    <c:choose>
                                        <c:when test="#{not empty sessionScope.user and buyTicketBean.isStationPrefer(buyTicketBean.startStation)}">
                                                <p:commandButton styleClass="btn-floating btn-flat transparent waves-effect prefer-button"
                                                                 icon="ui-icon-star"/>
                                        </c:when>
                                        <c:when test="#{not empty sessionScope.user}">
                                                <p:commandButton styleClass="btn-floating btn-flat transparent waves-effect prefer-button"
                                                                 icon="ui-icon-star-border" actionListener="#{buyTicketBean.addPreferSubwayStation}"
                                                                 onsuccess="Materialize.toast('#{bundle.TipAddPreferStationSuccess}', 4000, 'rounded')"
                                                                 update="normal-buyticket-panel">
                                                    <f:param name="stationId" value="#{buyTicketBean.startStation.subwayStationId}"/>
                                                </p:commandButton>
                                        </c:when>
                                    </c:choose>
                                </h:form>
                            </td>
                            <td>
                                <h:form>
                                    #{buyTicketBean.endStation.displayName}
                                    <c:choose>
                                        <c:when test="#{not empty sessionScope.user and buyTicketBean.isStationPrefer(buyTicketBean.endStation)}">
                                            <p:commandButton styleClass="btn-floating btn-flat transparent waves-effect prefer-button"
                                                             icon="ui-icon-star">
                                            </p:commandButton>
                                        </c:when>
                                        <c:when test="#{not empty sessionScope.user}">
                                            <p:commandButton styleClass="btn-floating btn-flat transparent waves-effect prefer-button"
                                                             icon="ui-icon-star-border" actionListener="#{buyTicketBean.addPreferSubwayStation}"
                                                             onsuccess="Materialize.toast('#{bundle.TipAddPreferStationSuccess}', 4000, 'rounded')"
                                                             update="normal-buyticket-panel">
                                                <f:param name="stationId" value="#{buyTicketBean.endStation.subwayStationId}"/>
                                            </p:commandButton>
                                        </c:when>
                                    </c:choose>
                                </h:form>
                            </td>
                            <td>
                                <h:outputText value="#{buyTicketBean.ticketPrice.price}">
                                    <f:convertNumber currencySymbol="ï¿¥" type="currency" minFractionDigits="2" maxFractionDigits="2"/>
                                </h:outputText>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </c:if>
            </p:outputPanel>
        </div>

        <div id="station-msg-dialog" class="modal">
            <div class="modal-content">
                <h5 class="light-blue-text">#{bundle.StationMessage}</h5>
                <div class="station-msg-header">
                    <i class="material-icons left">schedule</i>
                    <span id="station-msg-time" class="left"></span>
                    <i class="material-icons left">person</i>
                    <span id="station-msg-publisher" class="left"></span>
                </div>
                <p id="station-msg" style="font-size: 18px"></p>
            </div>
            <div class="modal-footer">
                <a class="waves-effect waves-green btn-flat" onclick="$('#station-msg-dialog').closeModal()">
                    #{bundle.Close}
                </a>
            </div>
        </div>

    </ui:define>

</ui:composition>
